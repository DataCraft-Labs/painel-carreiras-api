{% extends "base.html" %}

{% block additional_css %}
<style>
    .search-and-filters-container, .visualization-container {
        max-width: 960px;
        margin: 2rem auto;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .visualization-container {
        background: #ffffff; /* Ensures visual consistency */
        text-align: center; /* Centers the text horizontally */
        padding: 20px;
    }
    .no-data {
        margin: 0; /* Removes any default margin */
        padding: 20px;
        color: #666; /* Optional: styles the color of the text */
    }
    .filter-group {
        display: flex;
        margin-bottom: 1rem;
    }
    .filter-select {
        flex: 1;
        padding: 10px;
        margin-right: 10px;
        border: 2px solid #ccc;
        border-radius: 4px;
    }
    .button {
        padding: 10px 20px;
        background-color: #4a47a3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .button:hover {
        background-color: #6862a5;
    }
    canvas {
        width: 100%;
        height: 400px;
    }
</style>
{% endblock %}

{% block content %}
<div class="search-and-filters-container">
    <div class="filter-group">
        <select class="filter-select" name="position" id="position-select" hx-get="/dropdown_data" hx-target="#position-select" hx-swap="innerHTML" hx-trigger="load">
            <option value="">Select a position...</option>
        </select>
        <select class="filter-select" name="location" id="location-select" hx-get="/dropdown_data" hx-target="#location-select" hx-swap="innerHTML" hx-trigger="load">
            <option value="">Select a location...</option>
        </select>
        <select class="filter-select" name="company" id="company-select" hx-get="/dropdown_data" hx-target="#company-select" hx-swap="innerHTML" hx-trigger="load">
            <option value="">Select a company...</option>
        </select>
        <button class="button" id="search-btn">Search</button>
    </div>
</div>
<div class="visualization-container">
    <canvas id="salaryChart" style="display:none;"></canvas>
    <p id="no-data-message" class="no-data">No data loaded yet.</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.getElementById('search-btn').addEventListener('click', function() {
    const position = document.getElementById('position-select').value;
    const location = document.getElementById('location-select').value;
    const company = document.getElementById('company-select').value;

    fetch(`/salary_distribution?position=${encodeURIComponent(position)}&location=${encodeURIComponent(location)}&company=${encodeURIComponent(company)}`)
        .then(response => response.json())
        .then(data => {
            if (data.salaries.length > 0) {
                document.getElementById('no-data-message').style.display = 'none';
                document.getElementById('salaryChart').style.display = 'block';
                const ctx = document.getElementById('salaryChart').getContext('2d');
                const labels = data.salaries.map(d => d.salary);
                const counts = data.salaries.map(d => d.count);

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.salaries.map(d => `$${d.salary}`), // Use salary as the label for each bar
                        datasets: [{
                            label: 'Number of Postings',
                            data: data.salaries.map(d => d.count), // Count as the data for each bar
                            backgroundColor: 'rgba(106, 79, 158, 0.2)',
                            borderColor: 'rgba(106, 79, 158, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Count'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Salary'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: 'rgb(106, 79, 158)'
                                }
                            }
                        }
                    }
                });

                // Display Statistics
                document.getElementById('mean').textContent = `Mean: ${data.statistics.mean}`;
                document.getElementById('median').textContent = `Median: ${data.statistics.median}`;
                document.getElementById('std-deviation').textContent = `Standard Deviation: ${data.statistics.std_deviation}`;
            } else {
                document.getElementById('salaryChart').style.display = 'none';
                document.getElementById('no-data-message').style.display = 'block';
                document.getElementById('no-data-message').textContent = 'No data found for the selected criteria.';
            }
        })
        .catch(error => {
            console.error('Error loading the data:', error);
            document.getElementById('no-data-message').textContent = 'Error loading data. Please try again.';
        });
});
</script>
{% endblock %}
